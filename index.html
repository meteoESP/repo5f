

       <div class="card hum-card">
           <span class="lbl">Umidit√†</span>
           <div class="val-container">
                <span id="hum" class="val">--</span> <span class="unit">%</span>
           </div>
       </div>
   </div>


   <div id="debug">Inizializzazione sistema grafico...</div>


   <script>
       const brokerUrl = 'wss://test.mosquitto.org:8081';
       const topic = 'home/meteo/#';


       function log(msg, color="white") {
           const colorMap = { "white": "#eee", "red": "#ff6b6b", "yellow": "#feca57", "lime": "#00d2d3", "cyan": "#54a0ff" };
           const finalColor = colorMap[color] || color;
           const d = document.getElementById('debug');
           d.innerHTML = `<div style="color:${finalColor}">> ${msg}</div>` + d.innerHTML;
       }


       function aggiornaUI(id, valore) {
           const el = document.getElementById(id);
           if(el) {
               el.innerText = valore;
               el.style.color = "#54a0ff";
               setTimeout(() => el.style.color = "", 500);
           } else {
               log(`ERRORE: Elemento HTML '${id}' non trovato!`, "red");
           }
       }


       log(`Connessione a ${brokerUrl}...`);
       const client = mqtt.connect(brokerUrl);


       client.on('connect', () => {
           log("CONNESSO! Mi iscrivo ai topic...", "lime");
           client.subscribe(topic);
       });


       client.on('message', (topicRx, message) => {
           const msgStr = message.toString();
           const topicLow = topicRx.toLowerCase();


           log(`RICEVUTO [${topicRx}]: ${msgStr}`);


           // Caso A: JSON
           if (msgStr.includes("{")) {
               try {
                   const json = JSON.parse(msgStr);
                   if (json.temp) aggiornaUI("temp", json.temp);
                   if (json.hum) aggiornaUI("hum", json.hum);
                   if (json.pres) aggiornaUI("pres", json.pres);
                   log("JSON processato.", "lime");
                   return;
               } catch(e) {}
           }


           // Caso B: Numero
           const match = msgStr.match(/-?\d+(\.\d+)?/);
           let valoreFinale = match ? parseFloat(match[0]).toFixed(1) : null;


           if (!valoreFinale) {
               log("Nessun numero valido.", "warn");
               return;
           }


           if (topicLow.includes("temp")) {
               aggiornaUI("temp", valoreFinale);
           }
           else if (topicLow.includes("hum") || topicLow.includes("umid")) {
               aggiornaUI("hum", valoreFinale);
           }
           else if (topicLow.includes("pres")) {
               aggiornaUI("pres", Math.round(valoreFinale));
           }
           else {
               log("Topic non riconosciuto.", "warn");
           }
       });
   </script>
</body>
</html>


/* GR*/
